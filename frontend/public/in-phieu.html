<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8">
  <title>In phi·∫øu giao h√†ng</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    @media print {
      .no-print {
        display: none;
      }

      .invoice-box {
        page-break-after: always;
      }

      .invoice-box:first-of-type {
        page-break-before: always;
      }

      body * {
        visibility: hidden;
      }

      .invoice-box,
      .invoice-box * {
        visibility: visible;
      }

      .invoice-box {
        position: relative;
        left: 0;
        top: 0;
      }
    }

    .invoice-box {
      border: 1px solid #ddd;
      padding: 20px;
      margin-bottom: 40px;
      background-color: #fff;
    }

    .notes {
      margin-top: 20px;
      font-style: italic;
      font-size: 14px;
    }
  </style>
</head>

<body class="bg-light">
  <div class="container my-4">
    <div class="text-end mb-3 no-print">
      <button class="btn btn-success" onclick="window.print()">üñ® In phi·∫øu</button>
    </div>

    <div id="invoices"></div>
  </div>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script>
    function renderInvoice(order) {
      let rows = '';
      let total = 0;

      order.orderDetails.forEach((item, i) => {
        const sub = item.quantity * item.productSku.sellingPrice;
        total += sub;

        rows += ` 
          <tr>
            <td>${i + 1}</td>
            <td>${item.productSku.skuCode}</td>
            <td>${item.quantity}</td>
            <td>${item.productSku.sellingPrice.toLocaleString()}ƒë</td>
            <td>${sub.toLocaleString()}ƒë</td>
          </tr>
        `;
      });

      const today = new Date().toLocaleDateString('vi-VN');

      const address = order.address || {};
      const deliveryDate = new Date(order.deliveryDate).toLocaleDateString('vi-VN');
      const notes = [
        " - ƒê·ªÅ ngh·ªã Qu√Ω kh√°ch ki·ªÉm tra h√†ng khi nh·∫≠n h√†ng k√Ω x√°c nh·∫≠n v√† thanh to√°n.",
        " - Ch·ª©ng t·ª´ n√†y l√† cƒÉn c·ª© ƒë·ªÉ ƒë·ªëi chi·∫øu h√†ng h√≥a v√† c√¥ng n·ª£ ph√°t sinh.",
        " - C√≥ nh·∫ßm l·∫´n vui l√≤ng b√°o l·∫°i trong 48h k·ªÉ t·ª´ khi nh·∫≠n h√†ng."
      ];
      const shop = order.shop || {};

      $('#invoices').html(`
        <div class="invoice-box">
          <h4 class="text-center">PHI·∫æU GIAO H√ÄNG</h4>
          <p><strong>M√£ ƒë∆°n h√†ng:</strong> ${order.orderCode}</p>
          <p><strong>Ng√†y t·∫°o:</strong> ${new Date(order.createdAt).toLocaleDateString('vi-VN')}</p>
          <p><strong>Ng√†y giao:</strong> ${deliveryDate}</p>
          <p><strong>Kh√°ch h√†ng:</strong> ${address.recipientName}</p>
          <p><strong>ƒêi·ªán tho·∫°i:</strong> ${address.phone}</p>
          <p><strong>ƒê·ªãa ch·ªâ:</strong> ${address.address}, ${address.ward}, ${address.province}</p>
          <p><strong>T√™n c·ª≠a h√†ng:</strong> ${shop.name}</p>
          <p><strong>M√£ s·ªë thu·∫ø:</strong> ${shop.tin}</p>
          <p><strong>Danh s√°ch s·∫£n ph·∫©m:</strong></p>
          <table class="table table-bordered mt-3">
            <thead>
              <tr>
                <th>#</th>
                <th>S·∫£n ph·∫©m</th>
                <th>S·ªë l∆∞·ª£ng</th>
                <th>ƒê∆°n gi√°</th>
                <th>Th√†nh ti·ªÅn</th>
              </tr>
            </thead>
            <tbody>${rows}</tbody>
            <tfoot>
              <tr>
                <th colspan="4" class="text-end">T·ªïng c·ªông:</th>
                <th>${total.toLocaleString()}ƒë</th>
              </tr>
            </tfoot>
          </table>
          <p class="text-end"><strong>Ng√†y in:</strong> ${today}</p>
          <div class="notes">
            <p><strong>Ghi ch√∫:</strong></p>
            <ul>
              ${notes.map(note => `<li>${note}</li>`).join('')}
            </ul>
          </div>
          <div class="row text-center mt-5">
            <div class="col-4">
              <strong>Ng∆∞·ªùi l·∫≠p phi·∫øu</strong><br><br><br><br>
                (K√Ω, ghi r√µ h·ªç t√™n)
          </div>
          <div class="col-4">
              <strong>Ng∆∞·ªùi giao h√†ng</strong><br><br><br><br>
                 (K√Ω, ghi r√µ h·ªç t√™n)
           </div>
          <div class="col-4">
              <strong>Ng∆∞·ªùi nh·∫≠n h√†ng</strong><br><br><br><br>
                (K√Ω, ghi r√µ h·ªç t√™n)
          </div>
        </div>
        </div>

        <!-- B·∫£n th·ª© 2 c·ªßa phi·∫øu giao h√†ng -->
        <div class="invoice-box">
          <h4 class="text-center">PHI·∫æU GIAO H√ÄNG</h4>
          <p><strong>M√£ ƒë∆°n h√†ng:</strong> ${order.orderCode}</p>
          <p><strong>Ng√†y t·∫°o:</strong> ${new Date(order.createdAt).toLocaleDateString('vi-VN')}</p>
          <p><strong>Ng√†y giao:</strong> ${deliveryDate}</p>
          <p><strong>Kh√°ch h√†ng:</strong> ${address.recipientName}</p>
          <p><strong>ƒêi·ªán tho·∫°i:</strong> ${address.phone}</p>
          <p><strong>ƒê·ªãa ch·ªâ:</strong> ${address.address}, ${address.ward}, ${address.province}</p>
          <p><strong>T√™n c·ª≠a h√†ng:</strong> ${shop.name}</p>
          <p><strong>M√£ s·ªë thu·∫ø:</strong> ${shop.tin}</p>
          <p><strong>Danh s√°ch s·∫£n ph·∫©m:</strong></p>
          <table class="table table-bordered mt-3">
            <thead>
              <tr>
                <th>#</th>
                <th>S·∫£n ph·∫©m</th>
                <th>S·ªë l∆∞·ª£ng</th>
                <th>ƒê∆°n gi√°</th>
                <th>Th√†nh ti·ªÅn</th>
              </tr>
            </thead>
            <tbody>${rows}</tbody>
            <tfoot>
              <tr>
                <th colspan="4" class="text-end">T·ªïng c·ªông:</th>
                <th>${total.toLocaleString()}ƒë</th>
              </tr>
            </tfoot>
          </table>
          <p class="text-end"><strong>Ng√†y in:</strong> ${today}</p>
          <div class="notes">
            <p><strong>Ghi ch√∫:</strong></p>
            <ul>
              ${notes.map(note => `<li>${note}</li>`).join('')}
            </ul>
          </div>
          <div class="row text-center mt-5">
            <div class="col-4">
              <strong>Ng∆∞·ªùi l·∫≠p phi·∫øu</strong><br><br><br><br>
                (K√Ω, ghi r√µ h·ªç t√™n)
          </div>
          <div class="col-4">
              <strong>Ng∆∞·ªùi giao h√†ng</strong><br><br><br><br>
                 (K√Ω, ghi r√µ h·ªç t√™n)
           </div>
          <div class="col-4">
              <strong>Ng∆∞·ªùi nh·∫≠n h√†ng</strong><br><br><br><br>
                (K√Ω, ghi r√µ h·ªç t√™n)
          </div>
        </div>
      </div>
      `);

      setTimeout(() => window.print(), 500);
    }

    window.addEventListener("message", (event) => {
      if (event.origin !== window.location.origin) return;

      const order = event.data;
      if (!order || !order.orderCode) return;

      renderInvoice(order);
    });
  </script>
</body>

</html>